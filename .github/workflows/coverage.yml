name: Test Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    strategy:
      matrix:
        generator: [gen-zod, gen-typescript]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x

    - name: Run tests with coverage for ${{ matrix.generator }}
      working-directory: ${{ matrix.generator }}
      run: deno task test:coverage

    - name: Generate LCOV report for ${{ matrix.generator }}
      working-directory: ${{ matrix.generator }}
      run: deno task coverage:report

    - name: Extract coverage percentage for ${{ matrix.generator }}
      id: coverage
      working-directory: ${{ matrix.generator }}
      run: |
        # Extract coverage percentage from LCOV file
        if [ -f coverage.lcov ]; then
          # Calculate coverage percentage from LCOV
          LINES_FOUND=$(grep -c "^LF:" coverage.lcov || echo "0")
          LINES_HIT=$(grep -c "^LH:" coverage.lcov || echo "0")

          if [ "$LINES_FOUND" -gt 0 ]; then
            # Sum all LF and LH values
            TOTAL_LINES=$(grep "^LF:" coverage.lcov | cut -d: -f2 | awk '{sum += $1} END {print sum}')
            HIT_LINES=$(grep "^LH:" coverage.lcov | cut -d: -f2 | awk '{sum += $1} END {print sum}')

            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE=$(echo "scale=1; $HIT_LINES * 100 / $TOTAL_LINES" | bc)
            else
              COVERAGE="0"
            fi
          else
            COVERAGE="0"
          fi
        else
          COVERAGE="0"
        fi

        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage for ${{ matrix.generator }}: $COVERAGE%"

    - name: Create coverage badge for ${{ matrix.generator }}
      run: |
        COVERAGE="${{ steps.coverage.outputs.coverage }}"

        # Determine badge color based on coverage
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          COLOR="yellow"
        else
          COLOR="red"
        fi

        # Create project-specific badge directory
        mkdir -p badges/${{ matrix.generator }}

        # Generate badge SVG using shields.io
        curl -s "https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}" > badges/${{ matrix.generator }}/coverage.svg

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./badges
        destination_dir: badges
        keep_files: true

  comment-coverage:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: coverage

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x

    - name: Collect all coverage data
      id: collect
      run: |
        COVERAGE_REPORT="## ðŸ“Š Test Coverage Report\n\n"

        # Get coverage for each generator
        for generator in gen-zod gen-typescript; do
          if [ -d "$generator" ]; then
            cd "$generator"

            # Run coverage if deno.json has coverage tasks
            if grep -q "test:coverage" deno.json 2>/dev/null; then
              echo "Generating coverage for $generator..."
              deno task test:coverage > /dev/null 2>&1
              deno task coverage:report > /dev/null 2>&1

              if [ -f coverage.lcov ]; then
                # Calculate coverage percentage
                TOTAL_LINES=$(grep "^LF:" coverage.lcov | cut -d: -f2 | awk '{sum += $1} END {print sum}')
                HIT_LINES=$(grep "^LH:" coverage.lcov | cut -d: -f2 | awk '{sum += $1} END {print sum}')

                if [ "$TOTAL_LINES" -gt 0 ]; then
                  COVERAGE=$(echo "scale=1; $HIT_LINES * 100 / $TOTAL_LINES" | bc)
                else
                  COVERAGE="0"
                fi

                COVERAGE_REPORT="${COVERAGE_REPORT}**${generator}**: ${COVERAGE}%\n"
              fi
            fi

            cd ..
          fi
        done

        COVERAGE_REPORT="${COVERAGE_REPORT}\n*Generated by GitHub Actions*"

        # Save multiline string properly
        echo "COVERAGE_REPORT<<EOF" >> $GITHUB_OUTPUT
        echo -e "$COVERAGE_REPORT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Comment coverage on PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${{ steps.collect.outputs.COVERAGE_REPORT }}`
          })